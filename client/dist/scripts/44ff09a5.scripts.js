"use strict";angular.module("clientApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/where-to-send",{templateUrl:"views/where-to-send.html",controller:"LoginCtrl"}).when("/me",{templateUrl:"views/me.html",controller:"MeCtrl"}).when("/friends",{templateUrl:"views/friends.html",controller:"FriendsCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$timeout","Fb","Backend",function(a,b,c,d){a.getImage=function(){var b=Math.floor(100*Math.random())%5;return _.has(a,"image")?a.image:(a.image=b,b)},a.fetchUser=function(){var c=$.Deferred();return a.user?(b(function(){c.resolve()},0),c.promise()):(d.getCurrentUser().then(function(b){a.user=b,c.resolve()}),c.promise())}}]),function(a){var b,c="facebook-jssdk",d=a.getElementsByTagName("script")[0];a.getElementById(c)||(b=a.createElement("script"),b.id=c,b.async=!0,b.src="//connect.facebook.net/ru_RU/all.js",d.parentNode.insertBefore(b,d))}(document),window.fbAsyncInit=function(){function a(a){var b=window.document;if("createEvent"in b){var c=b.createEvent("HTMLEvents");c.initEvent(a,!1,!0),b.dispatchEvent(c)}else b.fireEvent(a)}var b=window.FB;window.fbConnected=!1,b.init({appId:"558478794247173",status:!0,cookie:!0,xfbml:!0}),b.Event.subscribe("auth.authResponseChange",function(c){"connected"===c.status?(console.log("FB connected",c),window.fbConnected=!0,a("fb-connected"),analytics.alias(c.authResponse.userID),b.api("/me",function(a){var b="";window._signedUp&&(console.log("Adding created date"),window._analyticsAddCreatedDate=!1,b=""+(new Date).getTime(),b=b.slice(0,10),b=parseInt(b),a.created_at=b),analytics.identify(a.id,a)})):"not_authorized"===c.status?b.login():b.login()}),a("fb-ready"),console.log("Ho ho ho, looks like I've connected to FB")},angular.module("clientApp").controller("MainCtrl",["$scope","$location","LocalStorage",function(a,b,c){analytics.page("Main Landing"),a.saveAndContinue=function(){analytics.track("Added a Wish",{descr:a.descr}),c.put("firstWish",{descr:a.descr}),b.path("/where-to-send")}}]),angular.module("clientApp").controller("LoginCtrl",["$scope","$location","Fb","Backend",function(a,b,c,d){function e(){return"$digest"===a.$$phase?(b.path("/me"),b.replace(),void 0):(a.$apply(function(){b.path("/me"),b.replace()}),void 0)}analytics.page("Where To Send - Login"),window._signedUp=!1,c.getLoginStatus().done(function(a){console.log("In controller",a),"connected"===a.status&&e()}),a.login=function(){window._signedUp=!0,c.login(function(b){b.authResponse?(e(),d.signup(b.authResponse)):a.$apply(function(){a.showError=!0})},{scope:"email"})}}]),angular.module("clientApp").service("Fb",function(){var a=window.document,b={};return b.getLoginStatus=function(){function a(){window.FB.getLoginStatus(function(a){console.log("Got login status",a),c.resolve(a)})}var c=$.Deferred();return b.runWhenReady(a),c.promise()},b.getUser=function(){function a(){window.FB.api("/me",function(a){console.log("Got user",a),c.resolve(a)})}var c=$.Deferred();return b.runWhenConnected(a),c.promise()},b.runWhenReady=function(b){_.has(window,"FB")?b():a.addEventListener("fb-ready",b)},b.runWhenConnected=function(b){return window.fbConnected?(b(),void 0):(a.addEventListener("fb-connected",b),void 0)},b.login=function(a,c){b.runWhenReady(function(){window.FB.login(a,c)})},b}),angular.module("clientApp").controller("MeCtrl",["$scope","$location","Fb","LocalStorage","Backend",function(a,b,c,d,e){analytics.page("My Letter");{var f;new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i")}a.wishlist=[],a.fetchUser().then(function(){a.wishlist=a.user.wishlist,a.letter=a.user.letter,f=d.get("firstWish"),f&&(d.remove("firstWish"),e.addWish(a.user,{descr:f}).then(function(b){a.wishlist.push(b)}))}),a.removedClass=function(a){return a.$markRemoved?"removed":""},a.isRemoved=function(a){return!!a.$markRemoved},a.triggerRemoved=function(b){console.log("in trigger removed",b),b.$markRemoved=!b.$markRemoved,b.$markRemoved&&(b.removed=!0),e.saveWish(a.user,b)},a.addingStarted=function(){return"adding a wish"===a.$action},a.startAdd=function(){a.$action="adding a wish"},a.cancelAdd=function(b){b.stopPropagation(),a.$action="",a.newWish=""},a.finishAdd=function(){e.addWish(a.user,{descr:a.newWish}).then(function(b){a.wishlist.push(b)}),a.$action="",a.newWish=""},a.startEdit=function(){a.newLetter=a.letter,a.$action="editing a letter"},a.editingStarted=function(){return"editing a letter"===a.$action},a.finishEdit=function(){e.saveLetter(a.user,a.newLetter),a.$action="",a.letter=a.newLetter,a.user.letter=a.newLetter,a.newLetter=""},a.cancelEdit=function(){a.$action="",a.newLetter=""},a.fetchUser()}]),angular.module("clientApp").service("LocalStorage",function(){var a=window.localStorage;return{put:function(b,c){console.log("in put",b,c),a[b]=angular.toJson(c)},get:function(b){return angular.fromJson(a[b])},remove:function(b){delete a[b]}}}),angular.module("clientApp").controller("FriendsCtrl",["$scope","LocalStorage","Backend",function(a,b,c){analytics.page("Friends"),a.settings=b.get("settings")||{},a.$loading=!0,a.fetchUser().then(function(){return c.getFriendsList(a.user).then(function(b){console.log("Got friends list",b),a.friends=b,a.$loading=!1})}),a.isLoading=function(){return!!a.$loading},a.isGiver=function(b){return b.givers?a.user?_.any(b.givers,function(b){return b.username===a.user.username}):!1:!1},a.wantToGive=function(b,d){b.givers=b.givers||[],b.givers.push(a.user),c.addGiver(a.user,b),analytics.track("Wants to Give",{userUsername:a.user.username,userId:a.user.id,wishDescr:b.descr,friendUsername:d.username})},a.dontWantToGive=function(b,d){b.givers=_.filter(b.givers,function(b){return b.username!==a.user.username}),c.removeGiver(a.user,b),analytics.track("Does Not Want to Give",{userUsername:a.user.username,userId:a.user.id,wishDescr:b.descr,friendUsername:d.username})},a.hideIntro=function(){a.settings.hideFriendsIntro=!0,b.put("settings",a.settings)},a.introHidden=function(){return!!a.settings.hideFriendsIntro}}]),angular.module("clientApp").service("Backend",["Fb","$http",function(a,b){function c(a){return console.log("Extracting",a.data),a.data.data}return{signup:function(d){a.getUser().pipe(function(a){return a.fbId=a.id,a.authData=d,a=_.omit(a,"id"),b({url:"/api/users/signup",method:"POST",data:angular.toJson(a)})}).pipe(c)},getCurrentUser:function(){var c=$.Deferred();return a.getUser().pipe(function(a){b({url:"/api/users",method:"GET",params:{"query[fbId]":a.id,fields:"name,username,id,letter,fbId,gender,wishlist"}}).then(function(a){c.resolve(a.data.data)})}),c.promise()},addWish:function(a,d){return d.userId=a._id,b({method:"POST",url:"/api/wishes",data:d}).then(c)},saveWish:function(a,d){return b({method:"PUT",url:"/api/wishes",data:d}).then(c)},saveLetter:function(a,d){return b({method:"PUT",url:"/api/users/"+a._id+"/letter",data:{letter:d}}).then(c)},getFriendsList:function(a){return b({method:"GET",url:"/api/users/"+a._id+"/friends"}).then(c)},addGiver:function(a,d){return b({method:"PUT",url:"/api/wishes/"+d._id+"/givers",data:_.pick(a,"_id","fbId","username","name","gender")}).then(c)},removeGiver:function(a,d){return console.log("Removing giver",_.pick(a,"_id")),b({method:"DELETE",url:"/api/wishes/"+d._id+"/givers/"+a._id}).then(c)}}}]);