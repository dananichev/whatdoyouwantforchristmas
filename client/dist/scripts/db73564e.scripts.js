"use strict";angular.module("clientApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/where-to-send",{templateUrl:"views/where-to-send.html",controller:"LoginCtrl"}).when("/me",{templateUrl:"views/me.html",controller:"MeCtrl"}).when("/friends",{templateUrl:"views/friends.html",controller:"FriendsCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","Fb",function(a,b){var c=["bear","bullfinch","deer","dm","penguin","snowman"];a.getImage=function(){var b=Math.floor(100*Math.random())%(c.length-1),d=a.image;return d&&d.length>0?a.image:(a.image=c[b],a.image)},a.fetchUser=function(){var c=$.Deferred();return a.user?(setTimeout(function(){c.resolve()},0),c.promise()):(b.getUser().then(function(b){a.$apply(function(){a.user=b,c.resolve()})}),c.promise())}}]),function(a){var b,c="facebook-jssdk",d=a.getElementsByTagName("script")[0];a.getElementById(c)||(b=a.createElement("script"),b.id=c,b.async=!0,b.src="//connect.facebook.net/ru_RU/all.js",d.parentNode.insertBefore(b,d))}(document),window.fbAsyncInit=function(){function a(a){var b=window.document;if("createEvent"in b){var c=b.createEvent("HTMLEvents");c.initEvent(a,!1,!0),b.dispatchEvent(c)}else b.fireEvent(a)}var b=window.FB;window.fbConnected=!1,b.init({appId:"558478794247173",status:!0,cookie:!0,xfbml:!0}),b.Event.subscribe("auth.authResponseChange",function(c){"connected"===c.status?(console.log("FB connected",c),window.fbConnected=!0,a("fb-connected"),analytics.alias(c.authResponse.userID),b.api("/me",function(a){var b="";window._analyticsAddCreatedDate&&(window._analyticsAddCreatedDate=!1,b=""+(new Date).getTime(),b=b.slice(0,10),b=parseInt(b),a.created_at=b),analytics.identify(a.id,a)})):"not_authorized"===c.status?b.login():b.login()}),a("fb-ready"),console.log("Ho ho ho, looks like I've connected to FB")},angular.module("clientApp").controller("MainCtrl",["$scope","$location","LocalStorage",function(a,b,c){analytics.page("Main Landing"),a.saveAndContinue=function(){analytics.track("Added a Wish",{descr:a.descr}),c.put("firstWish",{descr:a.descr}),b.path("/where-to-send")}}]),angular.module("clientApp").controller("LoginCtrl",["$scope","$location","Fb",function(a,b,c){analytics.page("Where To Send - Login"),window._analyticsAddCreatedDate=!0,c.runWhenReady(function(){window.FB.XFBML.parse()}),c.getLoginStatus().done(function(c){if(console.log("In controller",c),"connected"===c.status){if(window._analyticsAddCreatedDate=!1,console.log("phase",a.$$phase),"$digest"===a.$$phase)return b.path("/me"),b.replace(),void 0;a.$apply(function(){b.path("/me"),b.replace()})}})}]),angular.module("clientApp").service("Fb",function(){var a=window.document,b={};return b.getLoginStatus=function(){function a(){window.FB.getLoginStatus(function(a){console.log("Got login status",a),c.resolve(a)})}var c=$.Deferred();return b.runWhenReady(a),c.promise()},b.getUser=function(){function a(){window.FB.api("/me",function(a){console.log("Got user",a),c.resolve(a)})}var c=$.Deferred();return b.runWhenConnected(a),c.promise()},b.runWhenReady=function(b){_.has(window,"FB")?b():a.addEventListener("fb-ready",b)},b.runWhenConnected=function(b){return window.fbConnected?(b(),void 0):(a.addEventListener("fb-connected",b),void 0)},b}),angular.module("clientApp").controller("MeCtrl",["$scope","$location","Fb","LocalStorage",function(a,b,c,d){analytics.page("My Letter");var e,f=new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i");a.wishlist=[],e=d.get("firstWish"),e&&(a.wishlist.push(e),d.remove("firstWish")),a.removedClass=function(a){return a.$markRemoved?"removed":""},a.isRemoved=function(a){return!!a.$markRemoved},a.triggerRemoved=function(a){console.log("in trigger removed",a),a.$markRemoved=!a.$markRemoved},a.addingStarted=function(){return"adding a wish"===a.$action},a.startAdd=function(){a.$action="adding a wish"},a.cancelAdd=function(b){b.stopPropagation(),a.$action="",a.newWish=""},a.finishAdd=function(){f.test(a.newWish)&&console.log("Is URL"),a.wishlist.push({descr:a.newWish}),a.$action="",a.newWish=""},a.startEdit=function(){a.newLetter=a.letter,a.$action="editing a letter"},a.editingStarted=function(){return"editing a letter"===a.$action},a.finishEdit=function(){a.$action="",a.letter=a.newLetter,a.newLetter=""},a.cancelEdit=function(){a.$action="",a.newLetter=""},a.fetchUser()}]),angular.module("clientApp").service("LocalStorage",function(){var a=window.localStorage;return{put:function(b,c){console.log("in put",b,c),a[b]=angular.toJson(c)},get:function(b){return angular.fromJson(a[b])},remove:function(b){delete a[b]}}}),angular.module("clientApp").controller("FriendsCtrl",["$scope","LocalStorage",function(a,b){analytics.page("Friends"),a.settings=b.get("settings")||{},console.log("Settings",a.settings),a.fetchUser(),a.friends=[{name:"Evgenia Salomatina",username:"eugen.salomatina",gender:"female",letter:"Кастомное письмо. А подарки вот:",wishlist:[{descr:"Дешевле только тут - табуреты: табуретки для кухни, недорогой кухонный табурет, складные табуреты, дешевые табуретки  купить можно в нашем интернет-магазине",type:"link",address:"http://www.mebelklad.ru/index.php?categoryID=20"},{descr:"Шампиньоны, нарезанные тонко и вкусно запечёные щи!",givers:[{name:"Fipa Solo",username:"fipa.solo"},{name:"Andrey Salomatin",username:"filipovskii.off"}]}]},{name:"Andrey Pushkarev",username:"fealaer",gender:"male",wishlist:[{descr:"Доску для сёрфинга"},{descr:"Путёвку на двоих к океану"},{descr:"Годовой запас еды для Герцога"}]},{name:"Ilya Vakhrushev",username:"ilya.vakhrushev.9",gender:"male",wishlist:[{descr:"Бесконечно тонкий байк"},{descr:"Вафель"},{descr:"Новую работу"},{descr:"Кофе"}]}],a.isLoading=function(){return!1},a.isGiver=function(b){return b.givers?a.user?_.any(b.givers,function(b){return b.username===a.user.username}):!1:!1},a.wantToGive=function(b,c){b.givers=b.givers||[],b.givers.push(a.user),analytics.track("Wants to Give",{userUsername:a.user.username,userId:a.user.id,wishDescr:b.descr,friendUsername:c.username})},a.dontWantToGive=function(b,c){b.givers=_.filter(b.givers,function(b){return b.username!==a.user.username}),analytics.track("Does Not Want to Give",{userUsername:a.user.username,userId:a.user.id,wishDescr:b.descr,friendUsername:c.username})},a.hideIntro=function(){a.settings.hideFriendsIntro=!0,b.put("settings",a.settings)},a.introHidden=function(){return!!a.settings.hideFriendsIntro}}]);