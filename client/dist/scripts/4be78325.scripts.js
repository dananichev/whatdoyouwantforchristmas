"use strict";angular.module("clientApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/where-to-send",{templateUrl:"views/where-to-send.html",controller:"LoginCtrl"}).when("/me",{templateUrl:"views/me.html",controller:"MeCtrl"}).when("/friends",{templateUrl:"views/friends.html",controller:"FriendsCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$timeout","$location","Fb","Backend",function(a,b,c,d,e){a.getImage=function(){var b=Math.floor(100*Math.random())%5;return _.has(a,"image")?a.image:(a.image=b,b)},a.goToMyLetter=function(){return"$digest"===a.$$phase?(c.path("/me"),c.replace(),void 0):(a.$apply(function(){c.path("/me"),c.replace()}),void 0)},a.goToLogin=function(){"$digest"===a.$$phase&&c.path("/where-to-send"),a.$apply(function(){c.path("/where-to-send")})},a.fetchUser=function(){var c=$.Deferred();return a.user?(b(function(){c.resolve()},0),c.promise()):(e.getCurrentUser().then(function(b){a.user=b,b.id=b._id,analytics.identify(b.id,b),c.resolve()}),c.promise())}}]),function(a){var b,c="facebook-jssdk",d=a.getElementsByTagName("script")[0];a.getElementById(c)||(b=a.createElement("script"),b.id=c,b.async=!0,b.src="//connect.facebook.net/ru_RU/all.js",d.parentNode.insertBefore(b,d))}(document),window.fbAsyncInit=function(){function a(a){var b=window.document;if("createEvent"in b){var c=b.createEvent("HTMLEvents");c.initEvent(a,!1,!0),b.dispatchEvent(c)}else b.fireEvent(a)}var b=window.FB;window.fbConnected=!1,b.init({appId:"558478794247173",status:!0,cookie:!0,xfbml:!0}),b.Event.subscribe("auth.authResponseChange",function(b){"connected"===b.status?(console.log("FB authorized"),window.fbConnected=!0,a("fb-connected")):window.location.hash="not_authorized"===b.status?"/where-to-send":"/where-to-send"}),a("fb-ready"),console.log("Ho ho ho, looks like I've connected to FB")},angular.module("clientApp").controller("MainCtrl",["$scope","$location","Fb","LocalStorage",function(a,b,c,d){analytics.page("Main Landing"),c.getLoginStatus().done(function(b){"connected"===b.status&&a.goToMyLetter()}),a.saveAndContinue=function(){analytics.track("Added a Wish",{descr:a.descr}),d.put("firstWish",{descr:a.descr}),b.path("/where-to-send")}}]),angular.module("clientApp").controller("LoginCtrl",["$scope","$location","Fb","Backend",function(a,b,c,d){analytics.page("Where To Send - Login"),window._signedUp=!1,c.getLoginStatus().done(function(b){console.log("In controller",b),"connected"===b.status&&a.goToMyLetter()}),a.login=function(){window._signedUp=!0,analytics.track("Clicked login button"),c.login(function(b){b.authResponse?(analytics.track("Logged in"),a.goToMyLetter(),d.signup(b.authResponse)):(analytics.track("Got login error"),a.$apply(function(){a.showError=!0}))},{scope:"email"})}}]),angular.module("clientApp").service("Fb",function(){var a=window.document,b={};return b.getLoginStatus=function(){function a(){window.FB.getLoginStatus(function(a){console.log("Got login status",a),c.resolve(a)})}var c=$.Deferred();return b.runWhenReady(a),c.promise()},b.getUser=function(){function a(){window.FB.api("/me",function(a){console.log("Got user",a),c.resolve(a)})}var c=$.Deferred();return b.runWhenConnected(a),c.promise()},b.runWhenReady=function(b){_.has(window,"FB")?b():a.addEventListener("fb-ready",b)},b.runWhenConnected=function(b){return window.fbConnected?(b(),void 0):(a.addEventListener("fb-connected",b),void 0)},b.login=function(a,c){b.runWhenReady(function(){window.FB.login(a,c)})},b}),angular.module("clientApp").controller("MeCtrl",["$scope","$location","$timeout","Fb","LocalStorage","Backend",function(a,b,c,d,e,f){analytics.page("My Letter"),d.getLoginStatus().done(function(b){"connected"!==b.status&&a.goToLogin()});var g;a.wishlist=[],a.fetchUser().then(function(){a.wishlist=_.filter(a.user.wishlist,function(a){return!a.removed}),a.letter=a.user.letter,g=e.get("firstWish"),g&&(e.remove("firstWish"),f.addWish(a.user,g).then(function(b){a.wishlist.push(b)}))}),a.removedClass=function(a){return a.removed?"removed":""},a.isRemoved=function(a){return!!a.removed},a.removeWish=function(b,d){console.log("Removed a wish"),analytics.track("Removed a wish"),b.removed=!0,b.$hideAction=!0,c.cancel(b.$disapear),b.$disapear=c(function(){var b=$(d.target).parents("li"),c=["webkitAnimationEnd","MSAnimationEnd","animationend","oanimationend"];console.log("In timeout",b,d.target),b.addClass("fadeOutUp"),_.forEach(c,function(c){b.on(c,function(){console.log("Animation end"),b.remove(),a.wishlist=_.filter(a.wishlist,function(a){return!a.removed})})})},1e3),f.saveWish(a.user,b).then(function(){console.log("Saved"),b.$hideAction=!1})},a.restoreWish=function(b,d){console.log("Restored a wish"),analytics.track("Restored a wish"),$(d).parents("li").removeClass("fadeOutUp"),c.cancel(b.$disapear),b.removed=!1,b.$hideAction=!0,f.saveWish(a.user,b).then(function(){console.log("Saved"),b.$hideAction=!1})},a.showWishAction=function(a){return!a.$hideAction},a.addingStarted=function(){return"adding a wish"===a.$action},a.startAdd=function(){a.$action="adding a wish"},a.cancelAdd=function(b){b.stopPropagation(),a.$action="",a.newWish=""},a.finishAdd=function(){analytics.track("Added a wish"),f.addWish(a.user,{descr:a.newWish}).then(function(b){a.wishlist.push(b),a.user.wishlist.push(b)}),a.$action="",a.newWish=""},a.startEdit=function(){a.newLetter=a.letter,a.$action="editing a letter"},a.editingStarted=function(){return"editing a letter"===a.$action},a.finishEdit=function(){analytics.track("Changed a letter"),f.saveLetter(a.user,a.newLetter),a.$action="",a.letter=a.newLetter,a.user.letter=a.newLetter,a.newLetter=""},a.cancelEdit=function(){a.$action="",a.newLetter=""},a.fetchUser()}]),angular.module("clientApp").service("LocalStorage",function(){var a=window.localStorage;return{put:function(b,c){console.log("in put",b,c),a[b]=angular.toJson(c)},get:function(b){return angular.fromJson(a[b])},remove:function(b){delete a[b]}}}),angular.module("clientApp").controller("FriendsCtrl",["$scope","LocalStorage","Fb","Backend",function(a,b,c,d){analytics.page("Friends"),a.settings=b.get("settings")||{},c.getLoginStatus().done(function(b){"connected"!==b.status&&a.goToLogin()}),a.$loading=!0,a.fetchUser().then(function(){return d.getFriendsList(a.user).then(function(b){console.log("Got friends list",b),a.friends=b,a.$loading=!1})}),a.isLoading=function(){return!!a.$loading},a.isGiver=function(b){return b.givers?a.user?_.any(b.givers,function(b){return b.username===a.user.username}):!1:!1},a.wantToGive=function(b,c){b.givers=b.givers||[],b.givers.push(a.user),d.addGiver(a.user,b),analytics.track("Wants to Give",{userUsername:a.user.username,userId:a.user.id,wishDescr:b.descr,friendUsername:c.username})},a.dontWantToGive=function(b,c){b.givers=_.filter(b.givers,function(b){return b.username!==a.user.username}),d.removeGiver(a.user,b),analytics.track("Does Not Want to Give",{userUsername:a.user.username,userId:a.user.id,wishDescr:b.descr,friendUsername:c.username})},a.hideIntro=function(){a.settings.hideFriendsIntro=!0,b.put("settings",a.settings)},a.introHidden=function(){return!!a.settings.hideFriendsIntro}}]),angular.module("clientApp").service("Backend",["Fb","$http",function(a,b){function c(a){return console.log("Extracting",a.data),a.data.data}return{signup:function(d){a.getUser().pipe(function(a){return a.fbId=a.id,a.authData=d,a=_.omit(a,"id"),b({url:"/api/users/signup",method:"POST",data:angular.toJson(a)}).then(c)})},getCurrentUser:function(){var c=$.Deferred();return a.getUser().pipe(function(a){b({url:"/api/users",method:"GET",params:{"query[fbId]":a.id,fields:"name,first_name,last_name,username,id,email,letter,fbId,gender,wishlist"}}).then(function(a){c.resolve(a.data.data)})}),c.promise()},addWish:function(a,d){return d.userId=a._id,b({method:"POST",url:"/api/wishes",data:d}).then(c)},saveWish:function(a,d){return b({method:"PUT",url:"/api/wishes/"+d._id,data:d}).then(c)},saveLetter:function(a,d){return b({method:"PUT",url:"/api/users/"+a._id+"/letter",data:{letter:d}}).then(c)},getFriendsList:function(a){return b({method:"GET",url:"/api/users/"+a._id+"/friends"}).then(c)},addGiver:function(a,d){return b({method:"PUT",url:"/api/wishes/"+d._id+"/givers",data:_.pick(a,"_id","fbId","username","name","gender")}).then(c)},removeGiver:function(a,d){return console.log("Removing giver",_.pick(a,"_id")),b({method:"DELETE",url:"/api/wishes/"+d._id+"/givers/"+a._id}).then(c)}}}]);